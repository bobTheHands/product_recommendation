{% extends "base.html" %}
{% block headcontent %}
    <link ref="stylesheet" href="{{url_for('static', filename='css/jstarbox.css')}}">
    <link ref="stylesheet" href="{{url_for('static', filename='css/ie7.css')}}">
{% endblock headcontent %}
{% block content %}
<div class="container">

    <div class="card mt-4">
        <img class="card-img-top img-fluid" src="{{url_for('static', filename='img/products/{}'.format(img))}}" alt="">
        <div class="card-body">
            <h3 class="card-title">{{product.name}}</h3>
            <h4>${{product.price}}</h4>
            <p class="card-text">{{product.description}}</p>
            <span id="rating-text" class="text-info">
                Not rated
            </span>
            <div id="rating-stars"></div>
            
            <br><br>
            <span class="text-muted">Category: </span>
            <b class="text-primary">{{product.tags.replace("_", " ").capitalize()}}</b>
        </div>
    </div>
    <!-- /.card -->

    <div class="card card-outline-secondary my-4">
        <div class="card-header">
            Product Reviews
        </div>
        <div class="card-body">
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Omnis et enim aperiam inventore, similique
                necessitatibus neque non! Doloribus, modi sapiente laboriosam aperiam fugiat laborum. Sequi mollitia,
                necessitatibus quae sint natus.</p>
            <small class="text-muted">Posted by Anonymous on 3/1/17</small>
            <hr>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Omnis et enim aperiam inventore, similique
                necessitatibus neque non! Doloribus, modi sapiente laboriosam aperiam fugiat laborum. Sequi mollitia,
                necessitatibus quae sint natus.</p>
            <small class="text-muted">Posted by Anonymous on 3/1/17</small>
            <hr>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Omnis et enim aperiam inventore, similique
                necessitatibus neque non! Doloribus, modi sapiente laboriosam aperiam fugiat laborum. Sequi mollitia,
                necessitatibus quae sint natus.</p>
            <small class="text-muted">Posted by Anonymous on 3/1/17</small>
            <hr>
            <a href="#" class="btn btn-success">Leave a Review</a>
        </div>
    </div>
    <!-- /.card -->

    <h5 class="text-muted">Similar Products</h5>
    <br>
    <div class="row">

        {% for product in similar_products %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <a href="{{url_for('product.product', product_id=product.id)}}"><img class="card-img-top"
                        src="{{url_for('static', filename='img/products/{}'.format(os.path.basename(product.image)))}}"
                        alt=""></a>
                <div class="card-body">
                    <h4 class="card-title">
                        <a href="{{url_for('product.product', product_id=product.id)}}">{{product.name}}</a>
                    </h4>
                    <h5>${{product.price}}</h5>
                    <p class="card-text">{{product.description}}</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">&#9733; &#9733; &#9733; &#9733; &#9734;</small>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <a href="#"><img class="card-img-top" src="http://placehold.it/700x400" alt=""></a>
                <div class="card-body">
                    <h4 class="card-title">
                        <a href="#">Item One</a>
                    </h4>
                    <h5>$24.99</h5>
                    <p class="card-text">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Amet numquam
                        aspernatur!</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">&#9733; &#9733; &#9733; &#9733; &#9734;</small>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <a href="#"><img class="card-img-top" src="http://placehold.it/700x400" alt=""></a>
                <div class="card-body">
                    <h4 class="card-title">
                        <a href="#">Item Two</a>
                    </h4>
                    <h5>$24.99</h5>
                    <p class="card-text">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Amet numquam
                        aspernatur! Lorem ipsum dolor sit amet.</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">&#9733; &#9733; &#9733; &#9733; &#9734;</small>
                </div>
            </div>
        </div>
    </div>
    <script src="{{url_for('static', filename='js/jquery-3.3.1.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/jstarbox.js')}}"></script>
    <script>
        {% if review %}
        $("#rating-text").text({{review}}.toFixed(2) + " Stars");
        {% endif %}
        $("#rating-stars").starbox({
            changeable: 'once',
            ghosting: true,
            autoUpdateAverage: true,
            average: {{review}} / 5
        });
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        const recognition = new SpeechRecognition();
        recognition.interimResults = false;

        recognition.addEventListener("result", function (e) {

            const transcript = e.results[0][0].transcript;
            const confidence = e.results[0][0].confidence;
            var fd = new FormData();
            fd.append("transcription", transcript);
            fd.append("confidence", confidence);
            fd.append("product_id", "{{product.id}}")
            console.log(transcript + ": " + confidence);
            $.ajax({
                type: "POST",
                url: "{{url_for('product.upload_review')}}",
                data: fd,
                cache: false,
                processData: false,
                contentType: false
            }).done(function (review_score) {
                console.log(review_score);
                $("#rating-stars").starbox("setValue", review_score / 5)
                $("#rating-text").text(parseFloat(review_score).toFixed(2) + " Stars");
            });
        });

        recognition.start();

        </script>
</div>
<!-- /.col-lg-9 -->
{% endblock content %}